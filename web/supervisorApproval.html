<!DOCTYPE html>
<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
        <title>Reimbursement - Supervisor Overview</title>
    </head>

    <body onload="checkLogin()">
        <h1 style="text-align: center;">Supervisory Reimbursement Portal</h1>
        <input id="nameSearch" type="button" value="Retrieve Requests" style="margin-left: 45%;" onclick="getRequests(event)">
        <br><br>

        <div div="container">
            <table id="reqTable" class="table table-striped table-dark">
                <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Location</th>
                    <th>Description</th>
                    <th>Grade Type</th>
                    <th>Event Type</th>
                    <th>Justification</th>
                    <th>Projected Reimbursement</th>
                    <th>Submit Approval</th>
                </tr>
            </table>
        </div>
    </body>

    <script>
        function checkLogin() {
            // Redirect to log in page if cookies not set
            if(document.cookie == "") {
                //window.location.href = "login.html";
            }
        }

        var employeeName;
        var reqSuper;
        var returned_data;

        var nameCallback = function(returned_data) {
            console.log("Returned name data: " + returned_data);
            employeeName = returned_data;
        }

        var superCallback = function(returned_data) {
            console.log("Returned supervisor data: " + returned_data);
            reqSuper = returned_data;
        }

        function getRequests() {
            let xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200) {
                    let reqList = JSON.parse(this.responseText);

                    console.log(reqList);

                    // In each row, check whether the current user is the requester's supervisor
                    // If so, add the request to the table
                    for(var i = 0; i < reqList.length; i++) {
                        var thisReq = reqList[i];
                        console.log(thisReq);
                        var employeeId = thisReq.employeeId;
                        var myId = getCookie("userId");
                        getName(employeeId, nameCallback);
                        getReqSuper(thisReq.employeeId, superCallback);
                        console.log("This request's id is "+reqSuper);
                        
                        if(reqSuper == myId) {
                            var table = document.getElementById("reqTable");
                            var row = table.insertRow(1);
                            var cell1 = row.insertCell(0); 
                            var cell2 = row.insertCell(1); 
                            var cell3 = row.insertCell(2); 
                            var cell4 = row.insertCell(3);
                            var cell5 = row.insertCell(4);
                            var cell6 = row.insertCell(5);
                            var cell7 = row.insertCell(6);
                            var cell8 = row.insertCell(7);
                            var cell9 = row.insertCell(8);

                            row.setAttribute("data-reqId",thisReq.requestId);
                            row.id = "row"+thisReq.requestId;
                            cell1.innerHTML = employeeName;
                            cell2.innerHTML = thisReq.eventDate;
                            cell3.innerHTML = thisReq.eventLocation;
                            cell4.innerHTML = thisReq.eventDescription;
                            cell5.innerHTML = thisReq.gradeFormat;
                            cell6.innerHTML = thisReq.eventType;
                            cell7.innerHTML = thisReq.justification;
                            cell8.innerHTML = thisReq.projectedReimbursement;
                            cell9.innerHTML = "<input type=\"button\" value=\"Submit\" onclick=\"sendApproval(event)\"/>";
                        }
                    }
                }
            };

            url = "http://127.0.0.1:5000/request/";
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        function getName(employeeId, callback) {
            let superhttp = new XMLHttpRequest();

            superhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200) {
                    let thisEmployee = JSON.parse(this.responseText);
                    returned_data = thisEmployee.employeeName;
                    console.log("Employee name: " + returned_data);
                    callback.apply(this,[returned_data]);
                }
            };

            url = "http://127.00.1:5000/employee/" + employeeId + "/";
            // Even with callback functions I couldn't get this to work asynchronously
            superhttp.open("GET", url, false);
            superhttp.send();
        }

        function getReqSuper(requestId, callback) {
            let superhttp = new XMLHttpRequest();

            superhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200) {
                    let thisEmployee = JSON.parse(this.responseText);
                    console.log(thisEmployee);
                    console.log(thisEmployee.supervisorId);
                    returned_data = thisEmployee.supervisorId;
                    console.log("Supervisor id: " + returned_data);
                    callback.apply(this,[returned_data]);
                }
            }

            url = "http://127.0.0.1:5000/employee/" + requestId + "/";
            // Even with callback functions I couldn't get this to work asynchronously
            superhttp.open("GET", url, false);
            superhttp.send();
        }

        function sendApproval() {
            let xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200) {

                }
            };

            url = "http://127.0.0.1:5000/request/"
        }

        // Function obtained from https://stackoverflow.com/questions/10730362/get-cookie-by-name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    </script>
</html>